---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Willkommen bei TicTacToe.">
  <main>
    <h1>TicTacToe</h1>
    <table>
      <tbody>
        <tr>
          <td data-tictactoe-feld="1"></td>
          <td data-tictactoe-feld="2"></td>
          <td data-tictactoe-feld="3"></td>
        </tr>
        <tr>
          <td data-tictactoe-feld="4"></td>
          <td data-tictactoe-feld="5"></td>
          <td data-tictactoe-feld="6"></td>
        </tr>
        <tr>
          <td data-tictactoe-feld="7"></td>
          <td data-tictactoe-feld="8"></td>
          <td data-tictactoe-feld="9"></td>
        </tr>
      </tbody>
    </table>
  </main>
</Layout>

<script>
  let aktuellerSpieler = "X";
  let gewinner = "";

  /**
   * Das ist die Hauptfunktion die immer ausgeführt wird, wenn ein Benutzer auf ein TicTacToe-Feld drückt
   * @param feldNummer Enthält die Nummer des aktuellen Feldes
   */
  function click(feldNummer) {
    if (gewinner === "U") {
      zeigeUnentschieden();
      return;
    }
    if (gewinner !== "") {
      zeigeGewinner(aktuellerSpieler);
      return;
    }

    if (!istLeer(feldNummer)) {
      return;
    }

    ausfuellen(feldNummer, aktuellerSpieler);
    if (hatGewonnen(aktuellerSpieler)) {
      gewinner = aktuellerSpieler;
      zeigeGewinner(aktuellerSpieler);
    } else if (allesVoll()) {
      gewinner = "U";
      zeigeUnentschieden();
    } else {
      wechsleSpieler();
    }
  }

  function zeigeGewinner(spieler) {
    setTimeout(() => {
      if (confirm("Spieler " + spieler + " hat gewonnen. Noch eine Runde?")) {
        location.reload();
      }
    }, 0);
  }

  function zeigeUnentschieden() {
    setTimeout(() => {
      if (confirm("Unentschieden! Noch eine Runde?")) {
        location.reload();
      }
    }, 0);
  }

  function hatGewonnen(spieler) {
    // Horizontal prüfen
    if (inhalt(1) === spieler && inhalt(2) === spieler && inhalt(3) === spieler) {
      return true;
    }
    if (inhalt(4) === spieler && inhalt(5) === spieler && inhalt(6) === spieler) {
      return true;
    }
    if (inhalt(7) === spieler && inhalt(8) === spieler && inhalt(9) === spieler) {
      return true;
    }

    // Vertikal prüfen
    if (inhalt(1) === spieler && inhalt(2) === spieler && inhalt(3) === spieler) {
      return true;
    }
    if (inhalt(4) === spieler && inhalt(5) === spieler && inhalt(6) === spieler) {
      return true;
    }
    if (inhalt(7) === spieler && inhalt(8) === spieler && inhalt(9) === spieler) {
      return true;
    }

    // Diagonal prüfen
    if (inhalt(1) === spieler && inhalt(5) === spieler && inhalt(9) === spieler) {
      return true;
    }
    if (inhalt(3) === spieler && inhalt(5) === spieler && inhalt(7) === spieler) {
      return true;
    }
    return false;
  }

  /**
   * Wechselt den Spieler bzw. das aktuelle Symbol
   */
  function wechsleSpieler() {
    if (aktuellerSpieler === "X") {
      aktuellerSpieler = "O";
    } else {
      aktuellerSpieler = "X";
    }
  }

  /**
   * Prüft, ob das aktuelle Feld noch leer ist
   */
  function istLeer(feldNummer) {
    return inhalt(feldNummer) === "";
  }

  /**
   * Prüft ob bereits alle Felder voll sind
   */
  function allesVoll() {
    for (let i = 1; i <= 9; i++) {
      if (inhalt(i) === "") {
        return false;
      }
    }
    return true;
  }

  /**
   * Setzt das mitgegebene Symbol ins Feld
   */
  function ausfuellen(feldNummer, symbol) {
    document.querySelector("[data-tictactoe-feld='" + feldNummer + "']").innerHTML = symbol;
  }

  /**
   * Gibt den Inhalt eines Feldes zurück
   */
  function inhalt(feldNummer) {
    return document.querySelector("[data-tictactoe-feld='" + feldNummer + "']").innerHTML;
  }

  // Click verbinden mit Click funktion
  document.querySelectorAll("[data-tictactoe-feld]").forEach((element) => {
    /* @ts-ignore */
    element.addEventListener("click", () => click(element.dataset.tictactoeFeld));
  });
</script>

<style>
  table,
  td {
    border: 1px solid black;
  }
  td {
    width: 100px;
    height: 100px;
    position: relative;
    vertical-align: middle;
    text-align: center;
    font-size: 80px;
  }

  td:after {
    content: attr(data-tictactoe-feld);
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    text-align: center;
    width: 100%;
    color: rgba(233, 233, 233, 0.856);
    left: 0;
    z-index: -1;
  }
</style>
